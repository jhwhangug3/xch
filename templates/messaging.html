{% extends "base.html" %}

{% block title %}Messages - ChatApp{% endblock %}

{% block content %}
<div class="dashboard-content">
    <div class="dashboard-inner">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h4 class="mb-0">Messages</h4>
            <span class="badge bg-light text-dark">{{ friends|length }}</span>
        </div>
        
        {% if friends %}
            <div class="friends-grid">
                {% for friend in friends %}
                <div class="friend-item">
                    <a href="{{ url_for('view_user_profile_by_username', username=friend.username) }}" class="friend-avatar-link">
                        <div class="friend-avatar">
                            {% if friend.profile_picture %}
                                <img src="{{ friend.profile_picture }}" alt="" class="rounded-circle">
                            {% else %}
                                <div class="avatar-placeholder">
                                    <i class="fas fa-user"></i>
                                </div>
                            {% endif %}
                            {% if friend.is_online %}
                                <span class="online-dot"></span>
                            {% endif %}
                        </div>
                    </a>
                    <a href="{{ url_for('view_user_profile_by_username', username=friend.username) }}" class="friend-info-link">
                        <div class="friend-info">
                            <h6 class="friend-name">{{ friend.first_name or friend.username }}</h6>
                            <small class="friend-status">
                                {% if friend.is_online %}
                                    <span class="text-success">● Online</span>
                                {% else %}
                                    <span class="text-muted">○ Offline</span>
                                {% endif %}
                            </small>
                        </div>
                    </a>
                    <div class="friend-actions">
                        <a href="{{ url_for('direct_chat', user_id=friend.id) }}" class="btn btn-primary btn-sm" title="Start Chat">
                            <i class="fas fa-comment"></i>
                        </a>
                    </div>
                </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="empty-friends text-center py-5">
                <div class="empty-icon mb-3">
                    <i class="fas fa-comment"></i>
                </div>
                <h6 class="text-muted">No conversations yet</h6>
                <p class="text-muted small">Start chatting with your friends!</p>
            </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Presence bulk polling for friends
    document.addEventListener('DOMContentLoaded', function() {
        const items = Array.from(document.querySelectorAll('.friend-item'));
        const idMap = items.map(it => {
            const link = it.querySelector('.friend-actions a[href*="/chat/"]');
            if (!link) return null;
            const m = link.getAttribute('href').match(/\/chat\/(\d+)/);
            return m ? { el: it, id: parseInt(m[1]) } : null;
        }).filter(Boolean);
        
        async function pollPresence() {
            if (idMap.length === 0) return;
            const ids = idMap.map(x => x.id).join(',');
            try {
                const res = await fetch(`/api/presence/bulk?ids=${encodeURIComponent(ids)}`);
                const data = await res.json();
                idMap.forEach(({ el, id }) => {
                    const online = data[String(id)] && data[String(id)].online;
                    const dot = el.querySelector('.online-dot');
                    const label = el.querySelector('.friend-status');
                    if (online) {
                        if (dot) dot.style.display = '';
                        if (label) label.innerHTML = '<span class="text-success">● Online</span>';
                    } else {
                        if (dot) dot.style.display = 'none';
                        if (label) label.innerHTML = '<span class="text-muted">○ Offline</span>';
                    }
                });
            } catch (e) {}
        }
        pollPresence();
        setInterval(pollPresence, 10000);
    });
</script>
{% endblock %}
